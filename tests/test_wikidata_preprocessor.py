from mwtext import WikidataPreprocessor
import json
import mwbase


def test_wikidata_preprocessing():
    wdpp = WikidataPreprocessor()
    item = """
{"claims":{"P1566":[{"mainsnak":{"snaktype":"value","property":"P1566","hash":"f53194a6c7681a57c421bf7a45deab9285a5de46","datavalue":{"value":"5294734","type":"string"},"datatype":"external-id"},"type":"statement","id":"Q49248361$6E7F19DF-1420-449B-BB4F-57343B8E77D1","rank":"normal","references":[{"hash":"43a0088c51fd85e5a85d1b46412c3a635e6d4edc","snaks":{"P143":[{"snaktype":"value","property":"P143","hash":"d8fbf8671e3c630db61bfac691068cfb6857f243","datavalue":{"value":{"entity-type":"item","numeric-id":837615,"id":"Q837615"},"type":"wikibase-entityid"},"datatype":"wikibase-item"}]},"snaks-order":["P143"]}]}],"P625":[{"mainsnak":{"snaktype":"value","property":"P625","hash":"e8c0a82076bb4da0f33d1c35b0910cc003b1b243","datavalue":{"value":{"latitude":32.608333333333,"longitude":-114.68472222222,"altitude":null,"precision":0.00027777777777778,"globe":"http://www.wikidata.org/entity/Q2"},"type":"globecoordinate"},"datatype":"globe-coordinate"},"type":"statement","id":"Q49248361$799BC9D5-C370-4707-AEB3-F8F29D0BA7A2","rank":"normal","references":[{"hash":"5490e1c6c24fc771126c2fbe6ca6a8ea524d3b48","snaks":{"P248":[{"snaktype":"value","property":"P248","hash":"c3ed7e4ccdd333ff9aec7f951cdf2ee06987b3ba","datavalue":{"value":{"entity-type":"item","numeric-id":136736,"id":"Q136736"},"type":"wikibase-entityid"},"datatype":"wikibase-item"}],"P577":[{"snaktype":"value","property":"P577","hash":"52797dbdb205fdadf98b9f5e61be9a0f437033a7","datavalue":{"value":{"time":"+2018-06-01T00:00:00Z","timezone":0,"before":0,"after":0,"precision":11,"calendarmodel":"http://www.wikidata.org/entity/Q1985727"},"type":"time"},"datatype":"time"}],"P590":[{"snaktype":"value","property":"P590","hash":"8a7724aa0ff786f638407819fb2201e69f4ce562","datavalue":{"value":"23526","type":"string"},"datatype":"external-id"}]},"snaks-order":["P248","P577","P590"]}]}],"P590":[{"mainsnak":{"snaktype":"value","property":"P590","hash":"8a7724aa0ff786f638407819fb2201e69f4ce562","datavalue":{"value":"23526","type":"string"},"datatype":"external-id"},"type":"statement","id":"Q49248361$02B348F0-24F3-42D6-B8F3-A8FD69E0C527","rank":"normal"}],"P17":[{"mainsnak":{"snaktype":"value","property":"P17","hash":"be4c6eafa2984964f04be85667263f5642ba1a72","datavalue":{"value":{"entity-type":"item","numeric-id":30,"id":"Q30"},"type":"wikibase-entityid"},"datatype":"wikibase-item"},"type":"statement","id":"Q49248361$0AEFFA8F-D947-4918-8EBE-D2AB1715438F","rank":"normal","references":[{"hash":"5490e1c6c24fc771126c2fbe6ca6a8ea524d3b48","snaks":{"P248":[{"snaktype":"value","property":"P248","hash":"c3ed7e4ccdd333ff9aec7f951cdf2ee06987b3ba","datavalue":{"value":{"entity-type":"item","numeric-id":136736,"id":"Q136736"},"type":"wikibase-entityid"},"datatype":"wikibase-item"}],"P577":[{"snaktype":"value","property":"P577","hash":"52797dbdb205fdadf98b9f5e61be9a0f437033a7","datavalue":{"value":{"time":"+2018-06-01T00:00:00Z","timezone":0,"before":0,"after":0,"precision":11,"calendarmodel":"http://www.wikidata.org/entity/Q1985727"},"type":"time"},"datatype":"time"}],"P590":[{"snaktype":"value","property":"P590","hash":"8a7724aa0ff786f638407819fb2201e69f4ce562","datavalue":{"value":"23526","type":"string"},"datatype":"external-id"}]},"snaks-order":["P248","P577","P590"]}]}],"P31":[{"mainsnak":{"snaktype":"value","property":"P31","hash":"2980f85a6e3e17e793554d41aba136dfe15b9bd8","datavalue":{"value":{"entity-type":"item","numeric-id":12284,"id":"Q12284"},"type":"wikibase-entityid"},"datatype":"wikibase-item"},"type":"statement","id":"Q49248361$4AA50630-06D8-4717-A3A8-82982DD8B016","rank":"normal","references":[{"hash":"5490e1c6c24fc771126c2fbe6ca6a8ea524d3b48","snaks":{"P248":[{"snaktype":"value","property":"P248","hash":"c3ed7e4ccdd333ff9aec7f951cdf2ee06987b3ba","datavalue":{"value":{"entity-type":"item","numeric-id":136736,"id":"Q136736"},"type":"wikibase-entityid"},"datatype":"wikibase-item"}],"P577":[{"snaktype":"value","property":"P577","hash":"52797dbdb205fdadf98b9f5e61be9a0f437033a7","datavalue":{"value":{"time":"+2018-06-01T00:00:00Z","timezone":0,"before":0,"after":0,"precision":11,"calendarmodel":"http://www.wikidata.org/entity/Q1985727"},"type":"time"},"datatype":"time"}],"P590":[{"snaktype":"value","property":"P590","hash":"8a7724aa0ff786f638407819fb2201e69f4ce562","datavalue":{"value":"23526","type":"string"},"datatype":"external-id"}]},"snaks-order":["P248","P577","P590"]}]}],"P131":[{"mainsnak":{"snaktype":"value","property":"P131","hash":"8033b9d5cbbf2d5f233c1d594a27c2247d7f6146","datavalue":{"value":{"entity-type":"item","numeric-id":58698,"id":"Q58698"},"type":"wikibase-entityid"},"datatype":"wikibase-item"},"type":"statement","id":"Q49248361$E23C63CA-7D97-472C-A6DA-842095222C7F","rank":"normal","references":[{"hash":"5490e1c6c24fc771126c2fbe6ca6a8ea524d3b48","snaks":{"P248":[{"snaktype":"value","property":"P248","hash":"c3ed7e4ccdd333ff9aec7f951cdf2ee06987b3ba","datavalue":{"value":{"entity-type":"item","numeric-id":136736,"id":"Q136736"},"type":"wikibase-entityid"},"datatype":"wikibase-item"}],"P577":[{"snaktype":"value","property":"P577","hash":"52797dbdb205fdadf98b9f5e61be9a0f437033a7","datavalue":{"value":{"time":"+2018-06-01T00:00:00Z","timezone":0,"before":0,"after":0,"precision":11,"calendarmodel":"http://www.wikidata.org/entity/Q1985727"},"type":"time"},"datatype":"time"}],"P590":[{"snaktype":"value","property":"P590","hash":"8a7724aa0ff786f638407819fb2201e69f4ce562","datavalue":{"value":"23526","type":"string"},"datatype":"external-id"}]},"snaks-order":["P248","P577","P590"]}]}]}}
"""
    item_doc = json.loads(item)
    entity = mwbase.Entity.from_json(item_doc)
    assert wdpp.process(entity) == [('P1566',), ('P625',), ('P590',), ('P17', 'Q30'),
                                    ('P31', 'Q12284'), ('P131', 'Q58698')]
